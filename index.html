<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë‹¤ì—°ì´ì˜ ì˜ì–´ ë‹¨ì–´ì¥</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Jua&display=swap');
        
        body { 
            font-family: 'Jua', sans-serif; 
            text-align: center; 
            background-color: #E0F7FA; 
            margin: 0; padding: 0; 
            touch-action: manipulation;
            height: 100vh; overflow: hidden; 
        }

        .container { 
            max-width: 800px; height: 95vh; margin: 0 auto; 
            background: white; border-radius: 25px; padding: 20px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.15); 
            display: flex; flex-direction: column; justify-content: space-between; 
            box-sizing: border-box; position: relative;
        }

        #loading-screen {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(255,255,255,0.95); border-radius: 25px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 999;
        }

        h2 { font-size: 28px; color: #00796B; margin: 10px 0; }
        .eng-font { font-family: 'Fredoka One', cursive; }
        
        button { 
            background-color: #00BCD4; color: white; border: none; padding: 15px 40px; 
            font-size: 22px; border-radius: 50px; cursor: pointer; 
            box-shadow: 0 6px 0 #0097A7; transition: transform 0.1s;
            font-family: 'Jua', sans-serif; width: 100%; max-width: 300px; margin: 0 auto;
        }
        button:active { transform: translateY(4px); box-shadow: 0 2px 0 #0097A7; }
        button.sub-btn { background-color: #FF7043; box-shadow: 0 6px 0 #E64A19; font-size: 18px; padding: 10px 20px; width: auto;}
        button.sub-btn:active { box-shadow: 0 2px 0 #E64A19; }

        .mic-btn {
            width: 80px; height: 80px; border-radius: 50%; padding: 0;
            background: #f44336; box-shadow: 0 6px 0 #d32f2f;
            font-size: 40px; display: flex; align-items: center; justify-content: center;
            margin: 20px auto;
        }
        .mic-btn.listening { animation: pulse-red 1.5s infinite; background: #ff1744; }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(255, 23, 68, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(255, 23, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 23, 68, 0); }
        }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; flex-grow: 1; align-content: center; }
        .day { 
            aspect-ratio: 1/1; display: flex; align-items: center; justify-content: center; 
            background: #F1F8E9; border-radius: 12px; font-size: 18px; cursor: pointer; color: #999; transition: 0.2s;
        }
        .day.has-data { 
            background: #B2EBF2; color: #006064; font-weight: bold; border: 2px solid #00BCD4; 
            box-shadow: 0 4px 0 #0097A7; transform: translateY(-2px);
        }
        .day.has-data:active { transform: translateY(2px); box-shadow: none; }
        .day.today { background: #FFEB3B; border: 3px solid #FBC02D; color: #000; animation: pulse 2s infinite;}
        
        .word-image { font-size: 100px; margin: 10px 0; cursor: pointer; }
        .word-text { font-size: 70px; color: #333; margin: 10px 0; cursor: pointer; }
        .word-meaning { font-size: 40px; color: #757575; }
        
        /* ìº”ë²„ìŠ¤ ìŠ¤íƒ€ì¼ */
        .canvas-wrapper { position: relative; width: 400px; height: 200px; margin: 0 auto; border: 3px dashed #BDC3C7; border-radius: 20px; background: #fff; overflow: hidden; }
        .canvas-guide { position: absolute; top:0; left:0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 70px; color: #E0E0E0; font-family: 'Fredoka One', cursive; z-index: 1; user-select: none; }
        canvas { position: absolute; top:0; left:0; width: 100%; height: 100%; z-index: 10; touch-action: none; background: transparent; }

        /* ììœ  ì“°ê¸°ìš© ë‹¨ì–´ ë¦¬ìŠ¤íŠ¸ */
        .review-words { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .review-word-item { 
            background: #FFF9C4; padding: 10px 20px; border-radius: 15px; border: 2px solid #FBC02D;
            font-size: 24px; color: #333; cursor: pointer;
        }
        .review-word-item:active { transform: scale(0.95); background: #FFEB3B; }

        .puzzle-box { display: flex; justify-content: center; gap: 10px; margin: 20px 0; flex-wrap: wrap; }
        .puzzle-char {
            background: #FFECB3; border: 2px solid #FFC107; border-radius: 10px;
            width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;
            font-size: 30px; font-weight: bold; color: #333;
        }
        .puzzle-area { margin: 20px 0; }
        .answer-container { display: flex; justify-content: center; gap: 8px; margin-bottom: 30px; min-height: 60px; }
        .answer-slot {
            width: 50px; height: 60px; border-bottom: 4px solid #333;
            display: flex; align-items: center; justify-content: center;
            font-size: 36px; font-weight: bold; color: #00796B;
            font-family: 'Fredoka One', cursive; cursor: pointer;
        }
        .scramble-container { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        .letter-btn {
            width: 60px; height: 60px; background: #FFECB3;
            border: 3px solid #FFC107; border-radius: 12px;
            font-size: 32px; font-weight: bold; color: #5D4037;
            font-family: 'Fredoka One', cursive; cursor: pointer;
            box-shadow: 0 4px 0 #FFA000; user-select: none; display: flex; align-items: center; justify-content: center;
        }
        .letter-btn.hidden { opacity: 0; pointer-events: none; }

        .sentence-box { 
            background-color: #E8F5E9; padding: 20px; border-radius: 15px; margin: 15px 0; 
            font-size: 24px; text-align: left; cursor: pointer; border-left: 5px solid #4CAF50; transition: 0.3s;
        }
        .sentence-box.active { background-color: #BBDEFB; border: 3px solid #2196F3; transform: scale(1.02); }
        .sentence-box.done { background-color: #C8E6C9; border: 3px solid #4CAF50; opacity: 0.7; pointer-events: none;}
        
        .view { display: none; height: 100%; flex-direction: column; justify-content: space-between; }
        .view.active { display: flex; }
        .progress-container { width: 100%; background: #eee; height: 15px; border-radius: 10px; overflow: hidden; margin-bottom: 10px;}
        .progress-bar { height: 100%; background: #00BCD4; width: 0%; transition: width 0.5s; }
        
        /* [NEW] ë‹¨ì–´ ìˆœì„œ í‘œì‹œ ë°°ì§€ */
        .word-counter {
            background: #E0F2F1; color: #00695C; padding: 5px 15px; border-radius: 20px;
            font-size: 16px; font-weight: bold; margin-bottom: 5px; display: inline-block;
        }
    </style>
</head>
<body>

<div class="container">
    <div id="loading-screen">
        <div style="font-size: 50px;">ğŸ“¡</div>
        <h3>ë‹¨ì–´ì¥ì„ ì—°ê²°í•˜ê³  ìˆì–´ìš”...</h3>
    </div>

    <div id="view-calendar" class="view">
        <div style="display:flex; justify-content:space-between; align-items:center; padding: 10px;">
            <button class="sub-btn" onclick="changeMonth(-1)">â—€</button>
            <span id="month-year" style="font-size:30px; font-weight:bold;"></span>
            <button class="sub-btn" onclick="changeMonth(1)">â–¶</button>
        </div>
        <div class="calendar-grid" id="calendar-body"></div>
        <div style="color:#555; margin-top:10px; font-weight:bold;">ğŸ‘‡ íŒŒë€ìƒ‰ ë‚ ì§œë¥¼ ëˆ„ë¥´ë©´ ì‹œì‘í•´ìš”!</div>
    </div>

    <div id="view-study" class="view">
        <div>
            <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                <button class="sub-btn" onclick="showCalendar()" style="padding: 8px 15px; font-size:16px;">ğŸ  ë‹¬ë ¥</button>
                <div id="word-count-badge" class="word-counter">ë‹¨ì–´ 1 / 2</div>
            </div>
            <h2 id="study-date-title" style="margin:0 0 10px 0;"></h2>
            <div class="progress-container"><div id="progress" class="progress-bar"></div></div>
        </div>
        <div id="study-content" style="flex-grow: 1; display: flex; flex-direction: column; justify-content: center;"></div>
    </div>
</div>

<script>
    // ============================================================
    // [ì„¤ì •] êµ¬ê¸€ ì‹œíŠ¸ ë§í¬ (ì—¬ê¸°ì— ë§í¬ë¥¼ ë„£ìœ¼ì„¸ìš”!)
    // ============================================================
    const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQUloHhQSGx9JvgRWyfVIZt_ibvnK_aeCnuwr6bd6MiKFPgx3CBqMSvfRyqsGNjxcmTza03kNEusRvi/pub?output=csv"; 
    
    let allData = [];
    let today = new Date();
    let currentMonth = new Date(today.getFullYear(), today.getMonth(), 1);
    
    // í•™ìŠµ ìƒíƒœ ê´€ë¦¬
    let studyQueue = [];
    let studyIndex = 0;
    let writeCount = 10;
    let currentStudyDate = "";
    
    let currentWriteMode = 'upper'; 
    let currentPuzzleAnswer = [];
    let currentPuzzleSource = [];
    
    let recognition;
    let targetSentence = ""; 
    let currentSentIndex = 1;

    let canvas, ctx, isDrawing = false;
    let synth = window.speechSynthesis;

    window.onload = function() {
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'en-US';
            recognition.continuous = false;
            recognition.interimResults = false;
        } else {
            alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•Šì•„ìš”.");
        }

        if(sheetUrl.includes("ì—¬ê¸°ì—")) {
            alert("HTML íŒŒì¼ì„ ì—´ì–´ êµ¬ê¸€ ì‹œíŠ¸ ë§í¬ë¥¼ ê¼­ ë„£ì–´ì£¼ì„¸ìš”!");
            return;
        }
        fetchData();
    };

    function normalizeDate(str) {
        if(!str) return "";
        let s = str.replace(/\./g, '-').replace(/\//g, '-').trim();
        let parts = s.split('-');
        if(parts.length === 3) {
            let y = parts[0];
            let m = parts[1].padStart(2, '0');
            let d = parts[2].padStart(2, '0');
            return `${y}-${m}-${d}`;
        }
        return s;
    }

    async function fetchData() {
        try {
            const res = await fetch(sheetUrl);
            const text = await res.text();
            parseCSV(text);
        } catch (error) {
            document.getElementById('loading-screen').innerHTML = `<h3>ì—°ê²° ì‹¤íŒ¨!ğŸ˜­</h3>`;
        }
    }

    function parseCSV(text) {
        const rows = text.replace(/\r/g, '').split('\n').slice(1);
        allData = rows.map(row => {
            const cols = row.split(',');
            if(cols.length < 2) return null;
            return {
                date: normalizeDate(cols[0]), 
                word: cols[1] ? cols[1].trim() : "",
                meaning: cols[2] ? cols[2].trim() : "",
                s1: cols[3] ? cols[3].trim() : "",
                s2: cols[4] ? cols[4].trim() : ""
            };
        }).filter(item => item !== null && item.word && item.date);

        document.getElementById('loading-screen').style.display = 'none';
        showCalendar();
        document.getElementById('view-calendar').classList.add('active');
    }

    function showCalendar() {
        switchView('view-calendar');
        const year = currentMonth.getFullYear();
        const month = currentMonth.getMonth();
        document.getElementById('month-year').innerText = `${year}ë…„ ${month + 1}ì›”`;
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const grid = document.getElementById('calendar-body');
        grid.innerHTML = `<div class="day-name" style="color:#e74c3c">ì¼</div><div class="day-name">ì›”</div><div class="day-name">í™”</div><div class="day-name">ìˆ˜</div><div class="day-name">ëª©</div><div class="day-name">ê¸ˆ</div><div class="day-name" style="color:#3498db">í† </div>`;
        for(let i=0; i<firstDay.getDay(); i++) grid.innerHTML += `<div class="empty"></div>`;
        for(let d=1; d<=lastDay.getDate(); d++) {
            const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const hasData = allData.some(item => item.date === dateStr);
            const isToday = (dateStr === new Date().toISOString().slice(0,10));
            let cls = "day"; let clickAttr = "";
            if(hasData) { cls += " has-data"; clickAttr = `onclick="startStudy('${dateStr}')"`; }
            if(isToday) cls += " today";
            grid.innerHTML += `<div class="${cls}" ${clickAttr}>${d}</div>`;
        }
    }
    function changeMonth(delta) { currentMonth.setMonth(currentMonth.getMonth() + delta); showCalendar(); }

    function startStudy(dateStr) {
        studyQueue = allData.filter(item => item.date === dateStr);
        if(studyQueue.length === 0) { alert("ì´ ë‚ ì§œì—ëŠ” ë‹¨ì–´ê°€ ì—†ì–´ìš”!"); return; }
        
        currentStudyDate = dateStr;
        studyIndex = 0;
        document.getElementById('study-date-title').innerText = dateStr;
        switchView('view-study');
        loadStep(studyIndex);
    }

    function loadStep(index) {
        // [ì¤‘ìš”] ëª¨ë“  ë‹¨ì–´(ì˜ˆ: 2ê°œ)ë¥¼ ë‹¤ ë§ˆì³¤ëŠ”ì§€ í™•ì¸
        if(index >= studyQueue.length) {
            showFinishOptions();
            return;
        }

        // ì§„í–‰ë¥  ë° ìˆœì„œ í‘œì‹œ ì—…ë°ì´íŠ¸
        const total = studyQueue.length;
        document.getElementById('word-count-badge').innerText = `ë‹¨ì–´ ${index + 1} / ${total}`;
        const progress = (index / total) * 100;
        document.getElementById('progress').style.width = progress + "%";

        const data = studyQueue[index];
        const emojis = ["ğŸ", "ğŸ¶", "ğŸ±", "ğŸšŒ", "ğŸ•", "âš½", "â­", "ğŸŒˆ", "ğŸ“š", "ğŸš—", "âœˆï¸"];
        const randEmoji = emojis[Math.floor(Math.random()*emojis.length)];
        const upperWord = data.word.toUpperCase();

        document.getElementById('study-content').innerHTML = `
            <div id="step-1" style="animation:fadeIn 0.5s; text-align:center;">
                <div class="word-image" onclick="speak('${data.word}')">${randEmoji} <span style="font-size:30px">ğŸ”Š</span></div>
                <div class="word-text eng-font" onclick="speak('${data.word}')">${data.word}</div>
                <div class="word-meaning">${data.meaning}</div>
                <br><br>
                <button onclick="goStep2('${data.word}')">ì“°ê¸° ì—°ìŠµ (10ë²ˆ) ğŸ‘‰</button>
            </div>

            <div id="step-2" style="display:none; animation:fadeIn 0.5s; text-align:center;">
                <div style="display:flex; justify-content:center; align-items:center; gap:20px;">
                    <span style="font-size:50px;" onclick="speak('${data.word}')">${randEmoji}</span>
                    <span id="target-display" class="eng-font" style="font-size:50px; color:#333;">${upperWord}</span>
                </div>
                <div id="guide-msg" style="font-size:20px; color:#00796B; font-weight:bold; margin-bottom:5px;">ëŒ€ë¬¸ìë¥¼ ë”°ë¼ ì¨ë³´ì„¸ìš”!</div>
                <div class="canvas-wrapper">
                    <div id="canvas-guide-text" class="canvas-guide">${upperWord}</div>
                    <canvas id="drawCanvas" width="400" height="200"></canvas>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px; padding:0 20px;">
                    <div style="font-size:24px; font-weight:bold; color:#E91E63;">ë‚¨ì€ íšŸìˆ˜: <span id="cnt">10</span></div>
                    <div>
                        <button class="sub-btn" style="background:#90A4AE;" onclick="clearCanvas()">ì§€ìš°ê¸°</button>
                        <button class="sub-btn" onclick="checkWrite('${data.word}')">ë‹¤ ì¼ì–´ìš”!</button>
                    </div>
                </div>
            </div>

            <div id="step-3" style="display:none; animation:fadeIn 0.5s; text-align:center;">
                <h3>ì² ìë¥¼ ìˆœì„œëŒ€ë¡œ ëˆŒëŸ¬ë³´ì„¸ìš”!</h3>
                <div class="word-image" style="font-size:60px;" onclick="speak('${data.word}')">${randEmoji}</div>
                <div class="puzzle-area">
                    <div id="answer-box" class="answer-container"></div>
                    <div id="scramble-box" class="scramble-container"></div>
                </div>
                <br>
                <button onclick="checkPuzzle('${data.word}')">ì •ë‹µ í™•ì¸</button>
            </div>

            <div id="step-4" style="display:none; animation:fadeIn 0.5s; text-align:center;">
                <h3>ë”°ë¼ ë§í•´ë³´ì„¸ìš”! ( <span id="sent-step">1</span> / 2 )</h3>
                <div class="sentence-box eng-font" id="sent1">ğŸ”Š ${data.s1}</div>
                <div class="sentence-box eng-font" id="sent2" style="opacity:0.5;">ğŸ”Š ${data.s2}</div>
                <button id="micBtn" class="mic-btn" onclick="startListening()">ğŸ¤</button>
                <div id="speech-result" style="height:30px; font-size:20px; font-weight:bold; color:#0097A7; margin-top:10px;"></div>
                <br>
                <button class="sub-btn" style="background:#90A4AE; font-size:14px; margin-top:20px;" onclick="nextWord()">ë„ˆë¬´ ì–´ë ¤ì›Œìš” (ê±´ë„ˆë›°ê¸°)</button>
            </div>
        `;
        
        writeCount = 10;
        currentWriteMode = 'upper';
        initPuzzle(data.word);
        setTimeout(() => speak(data.word), 600);
    }

    // --- ì™„ë£Œ í™”ë©´ ---
    function showFinishOptions() {
        document.getElementById('progress').style.width = "100%";
        document.getElementById('word-count-badge').innerText = "í•™ìŠµ ì™„ë£Œ";
        
        document.getElementById('study-content').innerHTML = `
            <div style="text-align:center; animation:fadeIn 0.5s;">
                <div style="font-size:100px;">ğŸ‰</div>
                <h2 style="font-size:36px; margin-bottom:5px;">ì˜¤ëŠ˜ ê³µë¶€ ë!</h2>
                <p style="font-size:20px; color:#555; margin-bottom:40px;">ì •ë§ ëŒ€ë‹¨í•´ìš”. ë‹¤ìŒì€ ë¬´ì—‡ì„ í• ê¹Œìš”?</p>
                <button onclick="startNextDay()" style="margin-bottom:15px; width:90%; background:#2196F3;">ğŸš€ ë‹¤ìŒ ë‚  í•™ìŠµí•˜ê¸° (Go!)</button>
                <br>
                <button onclick="showFreeWriting()" style="margin-bottom:15px; width:90%; background:#FF9800;">âœï¸ ì“°ê¸° ì—°ìŠµ ë” í•˜ê¸°</button>
                <br>
                <button class="sub-btn" onclick="showCalendar()" style="background:#90A4AE; font-size:18px;">ğŸ  ë‹¬ë ¥ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
            </div>
        `;
    }

    function startNextDay() {
        if(!currentStudyDate) return;
        let parts = currentStudyDate.split('-');
        let d = new Date(Number(parts[0]), Number(parts[1])-1, Number(parts[2]));
        d.setDate(d.getDate() + 1); // +1ì¼
        let y = d.getFullYear(); let m = String(d.getMonth() + 1).padStart(2, '0'); let day = String(d.getDate()).padStart(2, '0');
        let nextDateStr = `${y}-${m}-${day}`;
        const hasData = allData.some(item => item.date === nextDateStr);
        if(hasData) startStudy(nextDateStr);
        else alert("ë‹¤ìŒ ë‚ ì§œ(" + nextDateStr + ")ì—ëŠ” ì•„ì§ ë‹¨ì–´ê°€ ì—†ì–´ìš”! ğŸ˜¢");
    }

    function showFreeWriting() {
        let wordsHtml = studyQueue.map(item => `<div class="review-word-item eng-font" onclick="speak('${item.word}')">${item.word}</div>`).join('');
        document.getElementById('study-content').innerHTML = `
            <div style="text-align:center; height:100%; display:flex; flex-direction:column; animation:fadeIn 0.5s;">
                <h3 style="margin:10px 0; color:#00796B;">ììœ  ì“°ê¸° ì—°ìŠµì¥ ğŸ“</h3>
                <div class="review-words">${wordsHtml}</div>
                <div class="canvas-wrapper" style="flex-grow:1; width:100%; border:3px solid #FFC107;">
                    <canvas id="drawCanvas" style="width:100%; height:100%;"></canvas>
                </div>
                <div style="margin-top:15px; display:flex; justify-content:center; gap:15px;">
                    <button class="sub-btn" style="background:#90A4AE;" onclick="clearCanvas()">ì§€ìš°ê¸°</button>
                    <button class="sub-btn" onclick="showCalendar()">ëë‚´ê¸°</button>
                </div>
            </div>
        `;
        setTimeout(() => {
            canvas = document.getElementById('drawCanvas'); ctx = canvas.getContext('2d');
            const dpr = window.devicePixelRatio || 1; const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * dpr; canvas.height = rect.height * dpr; ctx.scale(dpr, dpr);
            ctx.lineWidth = 4; ctx.lineCap = 'round'; ctx.strokeStyle = '#333';
            canvas.addEventListener('mousedown', start); canvas.addEventListener('mousemove', move); canvas.addEventListener('mouseup', end);
            canvas.addEventListener('touchstart', (e)=>{start(e.touches[0]);e.preventDefault();}, {passive:false});
            canvas.addEventListener('touchmove', (e)=>{move(e.touches[0]);e.preventDefault();}, {passive:false});
            canvas.addEventListener('touchend', end);
        }, 100);
    }

    // --- ì“°ê¸°/ë§í•˜ê¸°/í¼ì¦ (ê¸°ì¡´ê³¼ ë™ì¼) ---
    function goStep2() { document.getElementById('step-1').style.display='none'; document.getElementById('step-2').style.display='block'; setupCanvas(); }
    function hasEnoughInk() {
        const w = canvas.width; const h = canvas.height; const pixels = ctx.getImageData(0, 0, w, h).data;
        let colored = 0; for(let i=3; i<pixels.length; i+=4) if(pixels[i]>10) colored++; return colored > 300; 
    }
    function checkWrite(originalWord) {
        if(!hasEnoughInk()) { alert("ê¸€ì”¨ë¥¼ ë”°ë¼ ì¨ì£¼ì„¸ìš”! âœï¸"); return; }
        writeCount--; clearCanvas();
        if(writeCount <= 0) {
            speak("Good job!"); setTimeout(() => { alert("ì“°ê¸° ì™„ë£Œ! í¼ì¦ë¡œ ì´ë™!"); document.getElementById('step-2').style.display='none'; document.getElementById('step-3').style.display='block'; }, 500);
        } else { 
            if(currentWriteMode === 'upper') {
                currentWriteMode = 'lower'; const text = originalWord.toLowerCase();
                document.getElementById('target-display').innerText = text; document.getElementById('canvas-guide-text').innerText = text;
                document.getElementById('guide-msg').innerText = "ì´ì œ ì†Œë¬¸ìë¥¼ ì¨ë³´ì„¸ìš”!";
            } else {
                currentWriteMode = 'upper'; const text = originalWord.toUpperCase();
                document.getElementById('target-display').innerText = text; document.getElementById('canvas-guide-text').innerText = text;
                document.getElementById('guide-msg').innerText = "ë‹¤ì‹œ ëŒ€ë¬¸ìë¥¼ ì¨ë³´ì„¸ìš”!";
            }
            document.getElementById('cnt').innerText = writeCount; 
        }
    }
    function prepareSpeaking(stage) {
        currentSentIndex = stage; document.getElementById('sent-step').innerText = stage;
        const data = studyQueue[studyIndex];
        const s1 = document.getElementById('sent1'); const s2 = document.getElementById('sent2');
        document.getElementById('speech-result').innerText = "";
        if(stage===1) { targetSentence=data.s1; s1.classList.add('active'); s1.style.opacity="1"; s2.classList.remove('active'); s2.style.opacity="0.5"; speak(data.s1); }
        else { targetSentence=data.s2; s1.classList.remove('active'); s1.classList.add('done'); s2.classList.add('active'); s2.style.opacity="1"; speak(data.s2); }
    }
    function startListening() {
        if(!recognition) return;
        const btn = document.getElementById('micBtn'); const res = document.getElementById('speech-result');
        res.innerText="ë“£ê³  ìˆì–´ìš”..."; btn.classList.add('listening'); recognition.start();
        recognition.onresult=function(e){ const t=e.results[0][0].transcript; res.innerText="ğŸ—£ï¸ "+t; btn.classList.remove('listening'); checkSimilarity(t); };
        recognition.onerror=function(){ res.innerText="ë‹¤ì‹œ ë§í•´ì£¼ì„¸ìš”"; btn.classList.remove('listening'); };
        recognition.onend=function(){ btn.classList.remove('listening'); };
    }
    function checkSimilarity(s) {
        const t = targetSentence.toLowerCase().replace(/[^a-z0-9]/g, ""); const sp = s.toLowerCase().replace(/[^a-z0-9]/g, "");
        const sim = getSimilarity(t, sp);
        if(sim>=70) {
            speak("Good job!"); document.getElementById('speech-result').innerText = "ì •ë‹µ! ("+Math.round(sim)+"%)"; document.getElementById('speech-result').style.color="green";
            setTimeout(()=>{ if(currentSentIndex===1) prepareSpeaking(2); else nextWord(); }, 1500);
        } else {
            speak("Try again"); document.getElementById('speech-result').innerText = "ë¹„ìŠ·í•´ìš” ("+Math.round(sim)+"%)"; document.getElementById('speech-result').style.color="orange";
        }
    }
    function getSimilarity(s1,s2){ const l1=s1.length,l2=s2.length,m=Math.max(l1,l2); if(m===0)return 100; const mat=[]; for(let i=0;i<=l2;i++)mat[i]=[i]; for(let j=0;j<=l1;j++)mat[0][j]=j; for(let i=1;i<=l2;i++)for(let j=1;j<=l1;j++)mat[i][j]=(s2.charAt(i-1)==s1.charAt(j-1))?mat[i-1][j-1]:Math.min(mat[i-1][j-1]+1,Math.min(mat[i][j-1]+1,mat[i-1][j]+1)); return(1-mat[l2][l1]/m)*100; }
    function initPuzzle(w) { currentPuzzleAnswer=[]; let c=w.split('').map((x,i)=>({char:x,id:i})); currentPuzzleSource=c.sort(()=>Math.random()-0.5); renderPuzzleUI(); }
    function renderPuzzleUI() {
        document.getElementById('answer-box').innerHTML = currentPuzzleAnswer.map((x,i)=>`<div class="answer-slot" onclick="removeLetter(${i})">${x.char}</div>`).join('');
        document.getElementById('scramble-box').innerHTML = currentPuzzleSource.map(x=>{
            const used = currentPuzzleAnswer.some(a=>a.id===x.id); return `<div class="letter-btn ${used?'hidden':''}" onclick="addLetter('${x.char}',${x.id})">${x.char.toUpperCase()}</div>`;
        }).join('');
    }
    function addLetter(c,id){ currentPuzzleAnswer.push({char:c,id:id}); renderPuzzleUI(); speak(c); }
    function removeLetter(i){ currentPuzzleAnswer.splice(i,1); renderPuzzleUI(); }
    function checkPuzzle(t){ 
        if(currentPuzzleAnswer.map(x=>x.char).join('').toLowerCase()===t.toLowerCase()){ 
            speak("Correct!"); document.getElementById('step-3').style.display='none'; document.getElementById('step-4').style.display='block'; setTimeout(()=>prepareSpeaking(1),500); 
        } else { speak("Try again"); alert("í‹€ë ¸ì–´ìš”!"); currentPuzzleAnswer=[]; renderPuzzleUI(); } 
    }
    function speak(t) { if(!synth)return; synth.cancel(); const u=new SpeechSynthesisUtterance(t); u.lang='en-US'; u.rate=0.9; synth.speak(u); }
    function nextWord() { studyIndex++; loadStep(studyIndex); }
    function switchView(id) { document.querySelectorAll('.view').forEach(v=>v.classList.remove('active')); document.getElementById('loading-screen').style.display='none'; document.getElementById(id).classList.add('active'); }
    function clearCanvas() { ctx.clearRect(0,0,canvas.width,canvas.height); }
    function setupCanvas() {
        canvas=document.getElementById('drawCanvas'); ctx=canvas.getContext('2d');
        const dpr=window.devicePixelRatio||1; const r=canvas.getBoundingClientRect();
        canvas.width=r.width*dpr; canvas.height=r.height*dpr; ctx.scale(dpr,dpr);
        ctx.lineWidth=4; ctx.lineCap='round'; ctx.strokeStyle='#333';
        canvas.addEventListener('mousedown',start); canvas.addEventListener('mousemove',move); canvas.addEventListener('mouseup',end);
        canvas.addEventListener('touchstart',(e)=>{start(e.touches[0]);e.preventDefault();},{passive:false});
        canvas.addEventListener('touchmove',(e)=>{move(e.touches[0]);e.preventDefault();},{passive:false});
        canvas.addEventListener('touchend',end);
    }
    function start(e){ isDrawing=true; ctx.beginPath(); var r=canvas.getBoundingClientRect(); ctx.moveTo(e.clientX-r.left, e.clientY-r.top); }
    function move(e){ if(!isDrawing)return; var r=canvas.getBoundingClientRect(); ctx.lineTo(e.clientX-r.left, e.clientY-r.top); ctx.stroke(); }
    function end(){ isDrawing=false; }
</script>

</body>
</html>